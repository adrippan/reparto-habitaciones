<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reparto Habitaciones</title>
  <link rel="manifest" href="manifest.json"/>
  <script src="https://cdn.jsdelivr.net/npm/brython@3.9.5/brython.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/brython@3.9.5/brython_stdlib.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background: #f5f5f5; color: #333; }
    h1, h2 { text-align: center; color: #0a5e2b; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    th, td { padding: 0.5rem; border: 1px solid #ccc; text-align: left; }
    th { background: #eaeaea; }
    label { display: block; margin-bottom: 0.5rem; }
    input[type=number], input[type=text] { width: 100%; padding: 0.3rem; box-sizing: border-box; }
    button { background: #0a5e2b; color: #fff; border: none; padding: 0.7rem 1.2rem; border-radius: 5px; cursor: pointer; font-size: 1rem; transition: background 0.2s; margin: 0.2rem; }
    button:hover { background: #0e7c3a; }
    #error { color: #c00; margin-top: 1rem; }
    #result table { margin-top: 1rem; }
    .action-btn { padding: 0.3rem 0.6rem; font-size: 0.9rem; }
  </style>
</head>
<body onload="brython()">

  <h1>Reparto de Habitaciones</h1>

  <h2>Configuración de Habitaciones</h2>
  <button id="add-room" class="action-btn">Añadir Habitación</button>
  <table id="rooms-table">
    <tr><th>Nombre</th><th>Capacidad</th><th>Acciones</th></tr>
  </table>

  <h2>Tamaños de Grupos</h2>
  <button id="add-group" class="action-btn">Añadir Grupo</button>
  <table id="groups-table">
    <tr><th>Grupo</th><th>Chicos</th><th>Chicas</th><th>Acciones</th></tr>
  </table>

  <button id="btn" type="button">Asignar</button>

  <pre id="error"></pre>
  <div id="result"></div>

  <script type="text/python">
from browser import document, html, prompt
import heapq, json

def repartoHabitaciones(h, g):
    def cota_optimista(estado):
        asig, habs = estado
        return len(habs) - len(set(asig))
    def branch(estado):
        asig, habs = estado
        idx = len(asig)
        hijos = []
        for hab, cap in enumerate(habs):
            if g[idx] <= cap:
                es_chico = (idx % 2 == 0)
                habs_chicos = [h for pos,h in enumerate(asig) if pos%2==0]
                habs_chicas = [h for pos,h in enumerate(asig) if pos%2!=0]
                if (es_chico and hab not in habs_chicas) or (not es_chico and hab not in habs_chicos):
                    new_h = habs.copy(); new_h[hab] -= g[idx]
                    opt = cota_optimista((asig+[hab], new_h))
                    hijos.append((opt, (asig+[hab], new_h)))
        return hijos
    def is_complete(estado): return len(estado[0]) == len(g)
    A = []
    fx = 0
    ini = ([], h.copy())
    heapq.heappush(A, (-cota_optimista(ini), ini))
    while A and -A[0][0] > fx:
        _, estado = heapq.heappop(A)
        for sc, child in branch(estado):
            if is_complete(child):
                if sc > fx: fx, sol = sc, child
            else:
                if sc > fx: heapq.heappush(A, (-sc, child))
    return sol, fx

# Dynamic room list and group list
def add_room(name="", cap=20):
    idx = len(document["rooms-table"].get(selector="tr"))
    row = html.TR()
    row <= html.TD(html.INPUT(type="text", value=name, Class="name"))
    row <= html.TD(html.INPUT(type="number", value=cap, Class="cap"))
    del_btn = html.BUTTON("Borrar", Class="action-btn")
    def delete(ev): row.remove()
    del_btn.bind("click", delete)
    row <= html.TD(del_btn)
    document["rooms-table"] <= row

def add_group(ch=0, mo=0):
    rows = document["groups-table"].get(selector="tr")[1:]
    grp_id = len(rows) + 1
    row = html.TR()
    row <= html.TD(f"{grp_id}")
    row <= html.TD(html.INPUT(type="number", value=ch, Class="groupch"))
    row <= html.TD(html.INPUT(type="number", value=mo, Class="groupmo"))
    del_btn = html.BUTTON("Borrar", Class="action-btn")
    del_btn.bind("click", lambda ev: row.remove())
    row <= html.TD(del_btn)
    document["groups-table"] <= row

# Inicialización por defecto de habitaciones
for name in ["C","A","B","R","I","LL","A","S"] + [f"M{i}" for i in range(1,9)]:
    add_room(name, 20)

# Inicialización por defecto de 12 grupos con 10 chicos y 10 chicas
for _ in range(12):
    add_group(10, 10)

# Lógica de ejecución al pulsar Asignar

def run(ev=None):
    document["error"].text = ""; document["result"].html = ""
    try:
        h = [int(inp.value) for inp in document.get(selector="#rooms-table .cap")]
        g = []
        for row in document.get(selector="#groups-table tr")[1:]:
            inputs = row.get(selector="input")
            g.append(int(inputs[0].value)); g.append(int(inputs[1].value))
    except Exception as e:
        document["error"].text = f"Error lectura: {e}"
        return
    try:
        (asig, rem), vacias = repartoHabitaciones(h, g)
    except Exception as e:
        document["error"].text = f"Error reparto: {e}"
        return
    html_out = ["<h2>Asignación</h2><table><tr><th>Grupo</th><th>Sexo</th><th>Hab</th></tr>"]
    for idx, hab in enumerate(asig):
        grp = idx//2 + 1; sexo = "CHICOS" if idx%2==0 else "CHICAS"
        html_out.append(f"<tr><td>G{grp}</td><td>{sexo}</td><td>{document.get(selector="#rooms-table .name")[hab].value}</td></tr>")
    html_out.append("</table>")
    html_out.append("<h2>Capacidades restantes</h2><table><tr><th>Hab</th><th>Cap</th></tr>")
    for i, cap in enumerate(rem): html_out.append(f"<tr><td>{document.get(selector="#rooms-table .name")[i].value}</td><td>{cap}</td></tr>")
    html_out.append(f"</table><p><strong>Vacías:</strong> {vacias}</p>")
    document["result"].html = "".join(html_out)
document["btn"].bind("click", run)

document["add-room"].bind("click", lambda e: add_room(prompt("Nombre de habitación:"), 20))
document["add-group"].bind("click", lambda e: add_group())
  </script>

</body>
</html>
